<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: CombatTracker::Processor
  
    &mdash; Documentation by YARD 0.9.37
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "CombatTracker::Processor";
  relpath = '../';
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../_index.html">Index (P)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../CombatTracker.html" title="CombatTracker (module)">CombatTracker</a></span></span>
     &raquo; 
    <span class="title">Processor</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Module: CombatTracker::Processor
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>combattracker.rb</dd>
  </dl>
  
</div>





  <h2>Class Attribute Summary <small><a href="#" class="summary_toggle">collapse</a></small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#current_sequence-class_method" title="current_sequence (class method)">.<strong>current_sequence</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Holds the SequenceDef + timestamps while it’s running.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#pending_sequence-class_method" title="pending_sequence (class method)">.<strong>pending_sequence</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Holds the SequenceDef + timestamps while it’s running.</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#init_event-class_method" title="init_event (class method)">.<strong>init_event</strong>(attack_info)  &#x21d2; Hash </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Initializes a new event hash with attack information.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#init_sequence_event-class_method" title="init_sequence_event (class method)">.<strong>init_sequence_event</strong>(ci_id)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#parse_events-class_method" title="parse_events (class method)">.<strong>parse_events</strong>(lines)  &#x21d2; Array&lt;Hash&gt; </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Parses the lines of combat event data into structured events.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#persist-class_method" title="persist (class method)">.<strong>persist</strong>(ev)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Persists an event to the database.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#persist_flares-class_method" title="persist_flares (class method)">.<strong>persist_flares</strong>(flares, atk_id, seq, session_id)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Persists flare events associated with an attack.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#persist_lodged-class_method" title="persist_lodged (class method)">.<strong>persist_lodged</strong>(lodged, atk_id, ci_id, time)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Persists lodged events associated with an attack.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#persist_resolution-class_method" title="persist_resolution (class method)">.<strong>persist_resolution</strong>(res, atk_id, seq, session_id)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Persists the resolution of an attack.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#persist_statuses-class_method" title="persist_statuses (class method)">.<strong>persist_statuses</strong>(sts, atk_id, session_id)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Persists statuses associated with an attack.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process-class_method" title="process (class method)">.<strong>process</strong>(chunk)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Processes a chunk of combat event data.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#upsert_creature-class_method" title="upsert_creature (class method)">.<strong>upsert_creature</strong>(session_id, tgt)  &#x21d2; Integer </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Upserts a creature instance in the database.</p>
</div></span>
  
</li>

      
    </ul>
  


  <div id="class_attr_details" class="attr_details">
    <h2>Class Attribute Details</h2>
    
      
      <span id="current_sequence=-class_method"></span>
      <div class="method_details first">
  <h3 class="signature first" id="current_sequence-class_method">
  
    .<strong>current_sequence</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Holds the SequenceDef + timestamps while it’s running</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


348
349
350</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'combattracker.rb', line 348</span>

<span class='kw'>def</span> <span class='id identifier rubyid_current_sequence'>current_sequence</span>
  <span class='ivar'>@current_sequence</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="pending_sequence=-class_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="pending_sequence-class_method">
  
    .<strong>pending_sequence</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Holds the SequenceDef + timestamps while it’s running</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


348
349
350</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'combattracker.rb', line 348</span>

<span class='kw'>def</span> <span class='id identifier rubyid_pending_sequence'>pending_sequence</span>
  <span class='ivar'>@pending_sequence</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="init_event-class_method">
  
    .<strong>init_event</strong>(attack_info)  &#x21d2; <tt>Hash</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Initializes a new event hash with attack information.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_event'>event</span> <span class='op'>=</span> <span class='id identifier rubyid_init_event'>init_event</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Fireball</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>target:</span> <span class='lbrace'>{</span> <span class='label'>id:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Goblin</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span> <span class='rbrace'>}</span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>attack_info</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the information about the attack.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>a new event hash initialized with attack details.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'combattracker.rb', line 441</span>

<span class='kw'>def</span> <span class='id identifier rubyid_init_event'>init_event</span><span class='lparen'>(</span><span class='id identifier rubyid_attack_info'>attack_info</span><span class='rparen'>)</span>
  <span class='lbrace'>{</span>
    <span class='label'>name:</span> <span class='id identifier rubyid_attack_info'>attack_info</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>damaging:</span> <span class='id identifier rubyid_attack_info'>attack_info</span><span class='lbracket'>[</span><span class='symbol'>:damaging</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>spell:</span> <span class='id identifier rubyid_attack_info'>attack_info</span><span class='lbracket'>[</span><span class='symbol'>:spell</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>aoe:</span> <span class='id identifier rubyid_attack_info'>attack_info</span><span class='lbracket'>[</span><span class='symbol'>:aoe</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>target:</span> <span class='id identifier rubyid_attack_info'>attack_info</span><span class='lbracket'>[</span><span class='symbol'>:target</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='comma'>,</span>
    <span class='label'>resolution:</span> <span class='kw'>nil</span><span class='comma'>,</span>
    <span class='label'>damages:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>crits:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>statuses:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>flares:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>ctx:</span> <span class='symbol'>:attack</span><span class='comma'>,</span>
    <span class='label'>sequence_event_id:</span> <span class='kw'>nil</span><span class='comma'>,</span>
    <span class='label'>sequence_step:</span> <span class='int'>0</span>
  <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="init_sequence_event-class_method">
  
    .<strong>init_sequence_event</strong>(ci_id)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


459
460
461
462
463
464
465
466
467
468
469</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'combattracker.rb', line 459</span>

<span class='kw'>def</span> <span class='id identifier rubyid_init_sequence_event'>init_sequence_event</span><span class='lparen'>(</span><span class='id identifier rubyid_ci_id'>ci_id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_sd'>sd</span>   <span class='op'>=</span> <span class='id identifier rubyid_pending_sequence'>pending_sequence</span><span class='lbracket'>[</span><span class='symbol'>:def</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_seq_id'>seq_id</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="DebugInsert.html" title="CombatTracker::DebugInsert (module)">DebugInsert</a></span></span><span class='period'>.</span><span class='id identifier rubyid_insert'><span class='object_link'><a href="DebugInsert.html#insert-class_method" title="CombatTracker::DebugInsert.insert (method)">insert</a></span></span><span class='lparen'>(</span><span class='symbol'>:sequence_events</span><span class='comma'>,</span> <span class='lbrace'>{</span>
    <span class='label'>session_id:</span>           <span class='const'><span class='object_link'><a href="Session.html" title="CombatTracker::Session (module)">Session</a></span></span><span class='period'>.</span><span class='id identifier rubyid_current_id'><span class='object_link'><a href="Session.html#current_id-instance_method" title="CombatTracker::Session#current_id (method)">current_id</a></span></span><span class='comma'>,</span>
    <span class='label'>creature_instance_id:</span> <span class='id identifier rubyid_ci_id'>ci_id</span><span class='comma'>,</span> 
    <span class='label'>sequence_type_id:</span>     <span class='const'><span class='object_link'><a href="Lookup.html" title="CombatTracker::Lookup (module)">Lookup</a></span></span><span class='period'>.</span><span class='id identifier rubyid_id'><span class='object_link'><a href="Lookup.html#id-class_method" title="CombatTracker::Lookup.id (method)">id</a></span></span><span class='lparen'>(</span><span class='symbol'>:sequence_types</span><span class='comma'>,</span> <span class='id identifier rubyid_sd'>sd</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span><span class='comma'>,</span>
    <span class='label'>started_at:</span>           <span class='id identifier rubyid_pending_sequence'>pending_sequence</span><span class='lbracket'>[</span><span class='symbol'>:started_at</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>ended_at:</span>             <span class='id identifier rubyid_pending_sequence'>pending_sequence</span><span class='lbracket'>[</span><span class='symbol'>:ended_at</span><span class='rbracket'>]</span>
  <span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_current_sequence'>current_sequence</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='label'>id:</span> <span class='id identifier rubyid_seq_id'>seq_id</span><span class='comma'>,</span> <span class='label'>step:</span> <span class='int'>0</span><span class='comma'>,</span> <span class='label'>ci_id:</span> <span class='id identifier rubyid_ci_id'>ci_id</span> <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="parse_events-class_method">
  
    .<strong>parse_events</strong>(lines)  &#x21d2; <tt>Array&lt;Hash&gt;</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Parses the lines of combat event data into structured events.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_events'>events</span> <span class='op'>=</span> <span class='id identifier rubyid_parse_events'>parse_events</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Attack!</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>... and hit for 5 points of damage!</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>lines</span>
      
      
        <span class='type'>(<tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the lines of combat event data.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array&lt;Hash&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>an array of parsed event hashes.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'combattracker.rb', line 375</span>

<span class='kw'>def</span> <span class='id identifier rubyid_parse_events'>parse_events</span><span class='lparen'>(</span><span class='id identifier rubyid_lines'>lines</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_events'>events</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_current'>current</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='id identifier rubyid_lines'>lines</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_ln'>ln</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_sd'>sd</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Parser.html" title="CombatTracker::Parser (module)">Parser</a></span></span><span class='period'>.</span><span class='id identifier rubyid_parse_sequence_start'><span class='object_link'><a href="Parser.html#parse_sequence_start-class_method" title="CombatTracker::Parser.parse_sequence_start (method)">parse_sequence_start</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_ln'>ln</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_target'>target</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Parser.html" title="CombatTracker::Parser (module)">Parser</a></span></span><span class='period'>.</span><span class='id identifier rubyid_extract_link'><span class='object_link'><a href="Parser.html#extract_link-class_method" title="CombatTracker::Parser.extract_link (method)">extract_link</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_ln'>ln</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_sequence'>pending_sequence</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='label'>def:</span> <span class='id identifier rubyid_sd'>sd</span><span class='comma'>,</span> <span class='label'>started_at:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='comma'>,</span> <span class='label'>ended_at:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>target:</span> <span class='id identifier rubyid_target'>target</span> <span class='rbrace'>}</span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_pending_sequence'>pending_sequence</span> <span class='op'>&amp;&amp;</span> <span class='const'><span class='object_link'><a href="Parser.html" title="CombatTracker::Parser (module)">Parser</a></span></span><span class='period'>.</span><span class='id identifier rubyid_parse_sequence_end'><span class='object_link'><a href="Parser.html#parse_sequence_end-class_method" title="CombatTracker::Parser.parse_sequence_end (method)">parse_sequence_end</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_ln'>ln</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_pending_sequence'>pending_sequence</span><span class='lbracket'>[</span><span class='symbol'>:ended_at</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_a'>a</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Parser.html" title="CombatTracker::Parser (module)">Parser</a></span></span><span class='period'>.</span><span class='id identifier rubyid_parse_attack'><span class='object_link'><a href="Parser.html#parse_attack-class_method" title="CombatTracker::Parser.parse_attack (method)">parse_attack</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_ln'>ln</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_events'>events</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_current'>current</span> <span class='kw'>if</span> <span class='id identifier rubyid_current'>current</span>
      <span class='id identifier rubyid_current'>current</span> <span class='op'>=</span> <span class='id identifier rubyid_init_event'>init_event</span><span class='lparen'>(</span><span class='id identifier rubyid_a'>a</span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_pending_sequence'>pending_sequence</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_a'>a</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='id identifier rubyid_pending_sequence'>pending_sequence</span><span class='lbracket'>[</span><span class='symbol'>:def</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_a'>a</span><span class='lbracket'>[</span><span class='symbol'>:target</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_pending_sequence'>pending_sequence</span><span class='lbracket'>[</span><span class='symbol'>:target</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span>
        <span class='id identifier rubyid_current'>current</span><span class='lbracket'>[</span><span class='symbol'>:target</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_pending_sequence'>pending_sequence</span><span class='lbracket'>[</span><span class='symbol'>:target</span><span class='rbracket'>]</span>
        <span class='id identifier rubyid_current'>current</span><span class='lbracket'>[</span><span class='symbol'>:sequence_event</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_pending_sequence'>pending_sequence</span>
        <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_sequence'>pending_sequence</span><span class='lbracket'>[</span><span class='symbol'>:step</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='int'>0</span>
        <span class='id identifier rubyid_current'>current</span><span class='lbracket'>[</span><span class='symbol'>:sequence_step</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_sequence'>pending_sequence</span><span class='lbracket'>[</span><span class='symbol'>:step</span><span class='rbracket'>]</span> <span class='op'>+=</span> <span class='int'>1</span><span class='rparen'>)</span>
      <span class='kw'>end</span>

    <span class='kw'>elsif</span> <span class='id identifier rubyid_current'>current</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_ln'>ln</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\.\.\. and hit for (?&lt;d&gt;\d+) points? of damage!</span><span class='regexp_end'>/i</span></span>
      <span class='id identifier rubyid_current'>current</span><span class='lbracket'>[</span><span class='symbol'>:damages</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='const'>Regexp</span><span class='period'>.</span><span class='id identifier rubyid_last_match'>last_match</span><span class='lbracket'>[</span><span class='symbol'>:d</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
      <span class='id identifier rubyid_current'>current</span><span class='lbracket'>[</span><span class='symbol'>:ctx</span><span class='rbracket'>]</span>     <span class='op'>=</span> <span class='symbol'>:attack</span>

    <span class='kw'>elsif</span> <span class='id identifier rubyid_current'>current</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_ln'>ln</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\.\.\. (?&lt;d&gt;\d+) points of damage!</span><span class='regexp_end'>/i</span></span>
      <span class='id identifier rubyid_dmg'>dmg</span> <span class='op'>=</span> <span class='const'>Regexp</span><span class='period'>.</span><span class='id identifier rubyid_last_match'>last_match</span><span class='lbracket'>[</span><span class='symbol'>:d</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
      <span class='lparen'>(</span><span class='id identifier rubyid_current'>current</span><span class='lbracket'>[</span><span class='symbol'>:ctx</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='symbol'>:flare</span> <span class='op'>?</span> <span class='id identifier rubyid_current'>current</span><span class='lbracket'>[</span><span class='symbol'>:flares</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span> <span class='op'>:</span> <span class='id identifier rubyid_current'>current</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='symbol'>:damages</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_dmg'>dmg</span>

    <span class='kw'>elsif</span> <span class='id identifier rubyid_current'>current</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Parser.html" title="CombatTracker::Parser (module)">Parser</a></span></span><span class='period'>.</span><span class='id identifier rubyid_parse_resolution'><span class='object_link'><a href="Parser.html#parse_resolution-class_method" title="CombatTracker::Parser.parse_resolution (method)">parse_resolution</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_ln'>ln</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_current'>current</span><span class='lbracket'>[</span><span class='symbol'>:resolution</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_r'>r</span>

    <span class='kw'>elsif</span> <span class='id identifier rubyid_current'>current</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_l'>l</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Parser.html" title="CombatTracker::Parser (module)">Parser</a></span></span><span class='period'>.</span><span class='id identifier rubyid_parse_lodged'><span class='object_link'><a href="Parser.html#parse_lodged-class_method" title="CombatTracker::Parser.parse_lodged (method)">parse_lodged</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_ln'>ln</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_current'>current</span><span class='lbracket'>[</span><span class='symbol'>:lodged</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_l'>l</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_current'>current</span><span class='lbracket'>[</span><span class='symbol'>:target</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
        <span class='id identifier rubyid_t'>t</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Parser.html" title="CombatTracker::Parser (module)">Parser</a></span></span><span class='period'>.</span><span class='id identifier rubyid_extract_link'><span class='object_link'><a href="Parser.html#extract_link-class_method" title="CombatTracker::Parser.extract_link (method)">extract_link</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_ln'>ln</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='lbrace'>{</span> <span class='label'>id:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>noun:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='id identifier rubyid_raw_t'>raw_t</span> <span class='rbrace'>}</span>
        <span class='id identifier rubyid_current'>current</span><span class='lbracket'>[</span><span class='symbol'>:target</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_t'>t</span><span class='lbracket'>[</span><span class='symbol'>:target</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
      <span class='kw'>end</span>

    <span class='kw'>elsif</span> <span class='id identifier rubyid_current'>current</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_o'>o</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Parser.html" title="CombatTracker::Parser (module)">Parser</a></span></span><span class='period'>.</span><span class='id identifier rubyid_parse_outcome'><span class='object_link'><a href="Parser.html#parse_outcome-class_method" title="CombatTracker::Parser.parse_outcome (method)">parse_outcome</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_ln'>ln</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_current'>current</span><span class='lbracket'>[</span><span class='symbol'>:outcome</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_o'>o</span>

    <span class='kw'>elsif</span> <span class='id identifier rubyid_current'>current</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_s'>s</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Parser.html" title="CombatTracker::Parser (module)">Parser</a></span></span><span class='period'>.</span><span class='id identifier rubyid_parse_status'><span class='object_link'><a href="Parser.html#parse_status-class_method" title="CombatTracker::Parser.parse_status (method)">parse_status</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_ln'>ln</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_current'>current</span><span class='lbracket'>[</span><span class='symbol'>:statuses</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_s'>s</span>

    <span class='kw'>elsif</span> <span class='id identifier rubyid_current'>current</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_f'>f</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Parser.html" title="CombatTracker::Parser (module)">Parser</a></span></span><span class='period'>.</span><span class='id identifier rubyid_parse_flare'><span class='object_link'><a href="Parser.html#parse_flare-class_method" title="CombatTracker::Parser.parse_flare (method)">parse_flare</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_ln'>ln</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_current'>current</span><span class='lbracket'>[</span><span class='symbol'>:flares</span><span class='rbracket'>]</span>    <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='label'>damages:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>crits:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_current'>current</span><span class='lbracket'>[</span><span class='symbol'>:ctx</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='symbol'>:flare</span>

    <span class='kw'>elsif</span> <span class='id identifier rubyid_current'>current</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span> <span class='op'>=</span> <span class='const'>CritRanks</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_ln'>ln</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>&lt;.+?&gt;</span><span class='regexp_end'>/</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_values'>values</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_target'>target</span> <span class='op'>=</span> <span class='id identifier rubyid_current'>current</span><span class='lbracket'>[</span><span class='symbol'>:ctx</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='symbol'>:flare</span> <span class='op'>?</span> <span class='id identifier rubyid_current'>current</span><span class='lbracket'>[</span><span class='symbol'>:flares</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span> <span class='op'>:</span> <span class='id identifier rubyid_current'>current</span>
      <span class='id identifier rubyid_target'>target</span><span class='lbracket'>[</span><span class='symbol'>:crits</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='lbrace'>{</span> <span class='label'>type:</span> <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:type</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>location:</span> <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:location</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>rank:</span> <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:rank</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>fatal:</span> <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:fatal</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>

    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_events'>events</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_current'>current</span> <span class='kw'>if</span> <span class='id identifier rubyid_current'>current</span>
  <span class='id identifier rubyid_events'>events</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="persist-class_method">
  
    .<strong>persist</strong>(ev)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Persists an event to the database.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_persist'>persist</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Fireball</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>damage:</span> <span class='int'>10</span><span class='comma'>,</span> <span class='label'>target:</span> <span class='lbrace'>{</span> <span class='label'>id:</span> <span class='int'>1</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>ev</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the event data to persist.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>StandardError</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>if there is an issue with database operations.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'combattracker.rb', line 478</span>

<span class='kw'>def</span> <span class='id identifier rubyid_persist'>persist</span><span class='lparen'>(</span><span class='id identifier rubyid_ev'>ev</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_session_id'>session_id</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Session.html" title="CombatTracker::Session (module)">Session</a></span></span><span class='period'>.</span><span class='id identifier rubyid_current_id'><span class='object_link'><a href="Session.html#current_id-instance_method" title="CombatTracker::Session#current_id (method)">current_id</a></span></span>
  <span class='id identifier rubyid_seq'>seq</span>        <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Session.html" title="CombatTracker::Session (module)">Session</a></span></span><span class='period'>.</span><span class='id identifier rubyid_next_sequence'><span class='object_link'><a href="Session.html#next_sequence-instance_method" title="CombatTracker::Session#next_sequence (method)">next_sequence</a></span></span>
  <span class='id identifier rubyid_tgt'>tgt</span>        <span class='op'>=</span> <span class='id identifier rubyid_ev'>ev</span><span class='lbracket'>[</span><span class='symbol'>:target</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_ci_id'>ci_id</span>      <span class='op'>=</span> <span class='id identifier rubyid_upsert_creature'>upsert_creature</span><span class='lparen'>(</span><span class='id identifier rubyid_session_id'>session_id</span><span class='comma'>,</span> <span class='id identifier rubyid_tgt'>tgt</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_tgt'>tgt</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_now'>now</span>        <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>
  <span class='id identifier rubyid_outcome_id'>outcome_id</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='const'><span class='object_link'><a href="Lookup.html" title="CombatTracker::Lookup (module)">Lookup</a></span></span><span class='period'>.</span><span class='id identifier rubyid_id'><span class='object_link'><a href="Lookup.html#id-class_method" title="CombatTracker::Lookup.id (method)">id</a></span></span><span class='lparen'>(</span><span class='symbol'>:outcome_types</span><span class='comma'>,</span> <span class='id identifier rubyid_ev'>ev</span><span class='lbracket'>[</span><span class='symbol'>:outcome</span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='kw'>rescue</span> <span class='int'>1</span><span class='rparen'>)</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_ev'>ev</span><span class='lbracket'>[</span><span class='symbol'>:sequence_event</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_current_sequence'>current_sequence</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_ci_id'>ci_id</span>
    <span class='id identifier rubyid_init_sequence_event'>init_sequence_event</span><span class='lparen'>(</span><span class='id identifier rubyid_ci_id'>ci_id</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_attrs'>attrs</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='label'>session_id:</span>           <span class='id identifier rubyid_session_id'>session_id</span><span class='comma'>,</span>
    <span class='label'>sequence:</span>             <span class='id identifier rubyid_seq'>seq</span><span class='comma'>,</span>
    <span class='label'>creature_instance_id:</span> <span class='id identifier rubyid_ci_id'>ci_id</span><span class='comma'>,</span>
    <span class='label'>attack_type_id:</span>       <span class='const'><span class='object_link'><a href="Lookup.html" title="CombatTracker::Lookup (module)">Lookup</a></span></span><span class='period'>.</span><span class='id identifier rubyid_id'><span class='object_link'><a href="Lookup.html#id-class_method" title="CombatTracker::Lookup.id (method)">id</a></span></span><span class='lparen'>(</span><span class='symbol'>:attack_types</span><span class='comma'>,</span> <span class='id identifier rubyid_ev'>ev</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='comma'>,</span>
    <span class='label'>outcome_id:</span>           <span class='id identifier rubyid_outcome_id'>outcome_id</span><span class='comma'>,</span>
    <span class='label'>occurred_at:</span>          <span class='id identifier rubyid_now'>now</span>
  <span class='rbrace'>}</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_ev'>ev</span><span class='lbracket'>[</span><span class='symbol'>:sequence_event</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_attrs'>attrs</span><span class='lbracket'>[</span><span class='symbol'>:sequence_event_id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_current_sequence'>current_sequence</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_attrs'>attrs</span><span class='lbracket'>[</span><span class='symbol'>:sequence_step</span><span class='rbracket'>]</span>      <span class='op'>=</span> <span class='id identifier rubyid_ev'>ev</span><span class='lbracket'>[</span><span class='symbol'>:sequence_step</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_attack_id'>attack_id</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="DebugInsert.html" title="CombatTracker::DebugInsert (module)">DebugInsert</a></span></span><span class='period'>.</span><span class='id identifier rubyid_insert'><span class='object_link'><a href="DebugInsert.html#insert-class_method" title="CombatTracker::DebugInsert.insert (method)">insert</a></span></span><span class='lparen'>(</span><span class='symbol'>:attack_events</span><span class='comma'>,</span> <span class='id identifier rubyid_attrs'>attrs</span><span class='rparen'>)</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_ev'>ev</span><span class='lbracket'>[</span><span class='symbol'>:sequence_event</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_ev'>ev</span><span class='lbracket'>[</span><span class='symbol'>:sequence_event</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:ended_at</span><span class='rbracket'>]</span>
    <span class='const'><span class='object_link'><a href="DB.html" title="CombatTracker::DB (module)">DB</a></span></span><span class='period'>.</span><span class='id identifier rubyid_conn'><span class='object_link'><a href="DB.html#conn-instance_method" title="CombatTracker::DB#conn (method)">conn</a></span></span><span class='lbracket'>[</span><span class='symbol'>:sequence_events</span><span class='rbracket'>]</span>
      <span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>id:</span> <span class='id identifier rubyid_current_sequence'>current_sequence</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>ended_at:</span> <span class='id identifier rubyid_ev'>ev</span><span class='lbracket'>[</span><span class='symbol'>:sequence_event</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:ended_at</span><span class='rbracket'>]</span><span class='rparen'>)</span>

    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_current_sequence'>current_sequence</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_pending_sequence'>pending_sequence</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_ev'>ev</span><span class='lbracket'>[</span><span class='symbol'>:damages</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each_with_index'>each_with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_damage'>damage</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>      
  <span class='id identifier rubyid_damage_component'>damage_component</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='label'>attack_id:</span> <span class='id identifier rubyid_attack_id'>attack_id</span><span class='comma'>,</span>
      <span class='label'>damage:</span>    <span class='id identifier rubyid_damage'>damage</span><span class='comma'>,</span>
  <span class='rbrace'>}</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_outcome_id'>outcome_id</span> <span class='op'>==</span> <span class='int'>1</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_crit'>crit</span> <span class='op'>=</span> <span class='id identifier rubyid_ev'>ev</span><span class='lbracket'>[</span><span class='symbol'>:crits</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_damage_component'>damage_component</span><span class='lbracket'>[</span><span class='symbol'>:location_id</span><span class='rbracket'>]</span>    <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Lookup.html" title="CombatTracker::Lookup (module)">Lookup</a></span></span><span class='period'>.</span><span class='id identifier rubyid_id'><span class='object_link'><a href="Lookup.html#id-class_method" title="CombatTracker::Lookup.id (method)">id</a></span></span><span class='lparen'>(</span><span class='symbol'>:locations</span><span class='comma'>,</span> <span class='id identifier rubyid_crit'>crit</span><span class='lbracket'>[</span><span class='symbol'>:location</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_damage_component'>damage_component</span><span class='lbracket'>[</span><span class='symbol'>:critical_type</span><span class='rbracket'>]</span>  <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Lookup.html" title="CombatTracker::Lookup (module)">Lookup</a></span></span><span class='period'>.</span><span class='id identifier rubyid_id'><span class='object_link'><a href="Lookup.html#id-class_method" title="CombatTracker::Lookup.id (method)">id</a></span></span><span class='lparen'>(</span><span class='symbol'>:critical_types</span><span class='comma'>,</span> <span class='id identifier rubyid_crit'>crit</span><span class='lbracket'>[</span><span class='symbol'>:type</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_damage_component'>damage_component</span><span class='lbracket'>[</span><span class='symbol'>:critical_rank</span><span class='rbracket'>]</span>  <span class='op'>=</span> <span class='id identifier rubyid_crit'>crit</span><span class='lbracket'>[</span><span class='symbol'>:rank</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_damage_component'>damage_component</span><span class='lbracket'>[</span><span class='symbol'>:is_fatal</span><span class='rbracket'>]</span>       <span class='op'>=</span> <span class='id identifier rubyid_crit'>crit</span><span class='lbracket'>[</span><span class='symbol'>:fatal</span><span class='rbracket'>]</span>
    <span class='kw'>else</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_outcome_id'>outcome_id</span> <span class='op'>==</span> <span class='int'>1</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_ev'>ev</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span> <span class='op'>!=</span> <span class='symbol'>:natures_fury</span><span class='rparen'>)</span>
        <span class='const'><span class='object_link'><a href="Log.html" title="CombatTracker::Log (module)">Log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="Log.html#log-class_method" title="CombatTracker::Log.log (method)">log</a></span></span><span class='lparen'>(</span><span class='symbol'>:WARN</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CRIT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No crit message detected for attack </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ev'>ev</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_attack_id'>attack_id</span><span class='embexpr_end'>}</span><span class='tstring_content'>).</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='const'><span class='object_link'><a href="../CombatTracker.html" title="CombatTracker (module)">CombatTracker</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="DebugInsert.html" title="CombatTracker::DebugInsert (module)">DebugInsert</a></span></span><span class='period'>.</span><span class='id identifier rubyid_insert'><span class='object_link'><a href="DebugInsert.html#insert-class_method" title="CombatTracker::DebugInsert.insert (method)">insert</a></span></span><span class='lparen'>(</span><span class='symbol'>:damage_components</span><span class='comma'>,</span> <span class='id identifier rubyid_damage_component'>damage_component</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  

  <span class='id identifier rubyid_persist_statuses'>persist_statuses</span><span class='lparen'>(</span><span class='id identifier rubyid_ev'>ev</span><span class='lbracket'>[</span><span class='symbol'>:statuses</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_attack_id'>attack_id</span><span class='comma'>,</span> <span class='id identifier rubyid_session_id'>session_id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_persist_resolution'>persist_resolution</span><span class='lparen'>(</span><span class='id identifier rubyid_ev'>ev</span><span class='lbracket'>[</span><span class='symbol'>:resolution</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_attack_id'>attack_id</span><span class='comma'>,</span> <span class='id identifier rubyid_seq'>seq</span><span class='comma'>,</span> <span class='id identifier rubyid_session_id'>session_id</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_ev'>ev</span><span class='lbracket'>[</span><span class='symbol'>:resolution</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_persist_flares'>persist_flares</span><span class='lparen'>(</span><span class='id identifier rubyid_ev'>ev</span><span class='lbracket'>[</span><span class='symbol'>:flares</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_attack_id'>attack_id</span><span class='comma'>,</span> <span class='id identifier rubyid_seq'>seq</span><span class='comma'>,</span> <span class='id identifier rubyid_session_id'>session_id</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_ev'>ev</span><span class='lbracket'>[</span><span class='symbol'>:flares</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_any?'>any?</span>
  <span class='id identifier rubyid_persist_lodged'>persist_lodged</span><span class='lparen'>(</span><span class='id identifier rubyid_ev'>ev</span><span class='lbracket'>[</span><span class='symbol'>:lodged</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_attack_id'>attack_id</span><span class='comma'>,</span> <span class='id identifier rubyid_ci_id'>ci_id</span><span class='comma'>,</span> <span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_ev'>ev</span><span class='lbracket'>[</span><span class='symbol'>:lodged</span><span class='rbracket'>]</span>
  
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="persist_flares-class_method">
  
    .<strong>persist_flares</strong>(flares, atk_id, seq, session_id)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Persists flare events associated with an attack.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_persist_flares'>persist_flares</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='lbrace'>{</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Fire</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>damage:</span> <span class='int'>5</span><span class='comma'>,</span> <span class='label'>crit:</span> <span class='lbrace'>{</span> <span class='label'>type:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>lightning</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>location:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>nerves</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>rank:</span> <span class='int'>6</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='int'>1</span><span class='comma'>,</span> <span class='int'>1</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>session_123</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>flares</span>
      
      
        <span class='type'>(<tt>Array&lt;Hash&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the flare events to persist.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>atk_id</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the ID of the attack.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>seq</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the sequence number of the attack.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>tgt</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the target creature data.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>session_id</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the ID of the current session.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647
648
649
650
651
652
653
654
655
656
657
658
659
660
661
662
663
664
665</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'combattracker.rb', line 630</span>

<span class='kw'>def</span> <span class='id identifier rubyid_persist_flares'>persist_flares</span><span class='lparen'>(</span><span class='id identifier rubyid_flares'>flares</span><span class='comma'>,</span> <span class='id identifier rubyid_atk_id'>atk_id</span><span class='comma'>,</span> <span class='id identifier rubyid_seq'>seq</span><span class='comma'>,</span> <span class='id identifier rubyid_session_id'>session_id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_flares'>flares</span><span class='period'>.</span><span class='id identifier rubyid_each_with_index'>each_with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_fl'>fl</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_fl'>fl</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>blink|sigil_cast</span><span class='regexp_end'>/</span></span>
      <span class='id identifier rubyid_child_attack'>child_attack</span> <span class='op'>=</span> <span class='id identifier rubyid_atk_id'>atk_id</span> <span class='op'>+</span> <span class='int'>1</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_child_attack'>child_attack</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_flare_event_id'>flare_event_id</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../CombatTracker.html" title="CombatTracker (module)">CombatTracker</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="DebugInsert.html" title="CombatTracker::DebugInsert (module)">DebugInsert</a></span></span><span class='period'>.</span><span class='id identifier rubyid_insert'><span class='object_link'><a href="DebugInsert.html#insert-class_method" title="CombatTracker::DebugInsert.insert (method)">insert</a></span></span><span class='lparen'>(</span><span class='symbol'>:flare_events</span><span class='comma'>,</span> <span class='lbrace'>{</span>
        <span class='label'>session_id:</span>      <span class='id identifier rubyid_session_id'>session_id</span><span class='comma'>,</span>
        <span class='label'>attack_id:</span>       <span class='id identifier rubyid_atk_id'>atk_id</span><span class='comma'>,</span>
        <span class='label'>attack_sequence:</span> <span class='id identifier rubyid_seq'>seq</span><span class='comma'>,</span>
        <span class='label'>flare_sequence:</span>  <span class='id identifier rubyid_i'>i</span> <span class='op'>+</span> <span class='int'>1</span><span class='comma'>,</span>
        <span class='label'>flare_type_id:</span>   <span class='const'><span class='object_link'><a href="Lookup.html" title="CombatTracker::Lookup (module)">Lookup</a></span></span><span class='period'>.</span><span class='id identifier rubyid_id'><span class='object_link'><a href="Lookup.html#id-class_method" title="CombatTracker::Lookup.id (method)">id</a></span></span><span class='lparen'>(</span><span class='symbol'>:flare_types</span><span class='comma'>,</span> <span class='id identifier rubyid_fl'>fl</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='comma'>,</span>
        <span class='label'>child_attack_id:</span> <span class='id identifier rubyid_child_attack'>child_attack</span>
      <span class='rbrace'>}</span><span class='rparen'>)</span>
    
    <span class='kw'>if</span> <span class='id identifier rubyid_fl'>fl</span><span class='lbracket'>[</span><span class='symbol'>:damaging</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_fl'>fl</span><span class='lbracket'>[</span><span class='symbol'>:damages</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each_with_index'>each_with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_damage'>damage</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
      <span class='id identifier rubyid_damage_component'>damage_component</span> <span class='op'>=</span> <span class='lbrace'>{</span>
        <span class='label'>flare_id:</span>        <span class='id identifier rubyid_flare_event_id'>flare_event_id</span><span class='comma'>,</span>
          <span class='label'>damage:</span>          <span class='id identifier rubyid_damage'>damage</span><span class='comma'>,</span>
      <span class='rbrace'>}</span>
      
        <span class='kw'>if</span> <span class='id identifier rubyid_crit'>crit</span> <span class='op'>=</span> <span class='id identifier rubyid_fl'>fl</span><span class='lbracket'>[</span><span class='symbol'>:crits</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span><span class='rbracket'>]</span>
          <span class='id identifier rubyid_damage_component'>damage_component</span><span class='lbracket'>[</span><span class='symbol'>:location_id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Lookup.html" title="CombatTracker::Lookup (module)">Lookup</a></span></span><span class='period'>.</span><span class='id identifier rubyid_id'><span class='object_link'><a href="Lookup.html#id-class_method" title="CombatTracker::Lookup.id (method)">id</a></span></span><span class='lparen'>(</span><span class='symbol'>:locations</span><span class='comma'>,</span> <span class='id identifier rubyid_crit'>crit</span><span class='lbracket'>[</span><span class='symbol'>:location</span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_damage_component'>damage_component</span><span class='lbracket'>[</span><span class='symbol'>:critical_type</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Lookup.html" title="CombatTracker::Lookup (module)">Lookup</a></span></span><span class='period'>.</span><span class='id identifier rubyid_id'><span class='object_link'><a href="Lookup.html#id-class_method" title="CombatTracker::Lookup.id (method)">id</a></span></span><span class='lparen'>(</span><span class='symbol'>:critical_types</span><span class='comma'>,</span> <span class='id identifier rubyid_crit'>crit</span><span class='lbracket'>[</span><span class='symbol'>:type</span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_damage_component'>damage_component</span><span class='lbracket'>[</span><span class='symbol'>:critical_rank</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_crit'>crit</span><span class='lbracket'>[</span><span class='symbol'>:rank</span><span class='rbracket'>]</span>
          <span class='id identifier rubyid_damage_component'>damage_component</span><span class='lbracket'>[</span><span class='symbol'>:is_fatal</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_crit'>crit</span><span class='lbracket'>[</span><span class='symbol'>:fatal</span><span class='rbracket'>]</span>
        <span class='kw'>else</span>
          <span class='const'><span class='object_link'><a href="Log.html" title="CombatTracker::Log (module)">Log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="Log.html#log-class_method" title="CombatTracker::Log.log (method)">log</a></span></span><span class='lparen'>(</span><span class='symbol'>:WARN</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CRIT</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No crit message detected for flare </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_flare_event_id'>flare_event_id</span><span class='embexpr_end'>}</span><span class='tstring_content'>.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
        <span class='kw'>end</span>
        <span class='const'><span class='object_link'><a href="../CombatTracker.html" title="CombatTracker (module)">CombatTracker</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="DebugInsert.html" title="CombatTracker::DebugInsert (module)">DebugInsert</a></span></span><span class='period'>.</span><span class='id identifier rubyid_insert'><span class='object_link'><a href="DebugInsert.html#insert-class_method" title="CombatTracker::DebugInsert.insert (method)">insert</a></span></span><span class='lparen'>(</span><span class='symbol'>:damage_components</span><span class='comma'>,</span> <span class='id identifier rubyid_damage_component'>damage_component</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="persist_lodged-class_method">
  
    .<strong>persist_lodged</strong>(lodged, atk_id, ci_id, time)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Persists lodged events associated with an attack.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_persist_lodged'>persist_lodged</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>right eye</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>1</span><span class='comma'>,</span> <span class='int'>1</span><span class='comma'>,</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>lodged</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the lodged data.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>atk_id</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the ID of the attack.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>ci_id</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the ID of the creature instance.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>time</span>
      
      
        <span class='type'>(<tt>Time</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the time the lodged event occurred.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


676
677
678
679
680
681
682
683
684
685</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'combattracker.rb', line 676</span>

<span class='kw'>def</span> <span class='id identifier rubyid_persist_lodged'>persist_lodged</span><span class='lparen'>(</span><span class='id identifier rubyid_lodged'>lodged</span><span class='comma'>,</span> <span class='id identifier rubyid_atk_id'>atk_id</span><span class='comma'>,</span> <span class='id identifier rubyid_ci_id'>ci_id</span><span class='comma'>,</span> <span class='id identifier rubyid_time'>time</span><span class='rparen'>)</span>
  <span class='const'><span class='object_link'><a href="Log.html" title="CombatTracker::Log (module)">Log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="Log.html#log-class_method" title="CombatTracker::Log.log (method)">log</a></span></span><span class='lparen'>(</span><span class='symbol'>:DEBUG</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>LODG</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Lodged is </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_lodged'>lodged</span><span class='embexpr_end'>}</span><span class='tstring_content'>.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='const'><span class='object_link'><a href="../CombatTracker.html" title="CombatTracker (module)">CombatTracker</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="DebugInsert.html" title="CombatTracker::DebugInsert (module)">DebugInsert</a></span></span><span class='period'>.</span><span class='id identifier rubyid_insert'><span class='object_link'><a href="DebugInsert.html#insert-class_method" title="CombatTracker::DebugInsert.insert (method)">insert</a></span></span><span class='lparen'>(</span><span class='symbol'>:lodged_events</span><span class='comma'>,</span> <span class='lbrace'>{</span>
    <span class='label'>attack_id:</span>    <span class='id identifier rubyid_atk_id'>atk_id</span><span class='comma'>,</span>
    <span class='label'>creature_id:</span>  <span class='id identifier rubyid_ci_id'>ci_id</span><span class='comma'>,</span>
    <span class='label'>location_id:</span>  <span class='const'><span class='object_link'><a href="Lookup.html" title="CombatTracker::Lookup (module)">Lookup</a></span></span><span class='period'>.</span><span class='id identifier rubyid_id'><span class='object_link'><a href="Lookup.html#id-class_method" title="CombatTracker::Lookup.id (method)">id</a></span></span><span class='lparen'>(</span><span class='symbol'>:locations</span><span class='comma'>,</span> <span class='id identifier rubyid_lodged'>lodged</span><span class='rparen'>)</span><span class='comma'>,</span>
    <span class='label'>lodged_at:</span>    <span class='id identifier rubyid_time'>time</span><span class='comma'>,</span>
    <span class='label'>removed_at:</span>   <span class='kw'>nil</span>
  <span class='rbrace'>}</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="persist_resolution-class_method">
  
    .<strong>persist_resolution</strong>(res, atk_id, seq, session_id)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Persists the resolution of an attack.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code>persist_resolution({ type: &quot;as_ds&quot;, data: { total: 10, roll: 5 }, 1, 1, &quot;session_123&quot;)</code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>res</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the resolution data.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>atk_id</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the ID of the attack.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>seq</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the sequence number of the attack.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>session_id</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the ID of the current session.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>StandardError</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>if there is an issue with database operations.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'combattracker.rb', line 592</span>

<span class='kw'>def</span> <span class='id identifier rubyid_persist_resolution'>persist_resolution</span><span class='lparen'>(</span><span class='id identifier rubyid_res'>res</span><span class='comma'>,</span> <span class='id identifier rubyid_atk_id'>atk_id</span><span class='comma'>,</span> <span class='id identifier rubyid_seq'>seq</span><span class='comma'>,</span> <span class='id identifier rubyid_session_id'>session_id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_session_id'>session_id</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Session.html" title="CombatTracker::Session (module)">Session</a></span></span><span class='period'>.</span><span class='id identifier rubyid_current_id'><span class='object_link'><a href="Session.html#current_id-instance_method" title="CombatTracker::Session#current_id (method)">current_id</a></span></span>
  <span class='id identifier rubyid_type_id'>type_id</span>    <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Lookup.html" title="CombatTracker::Lookup (module)">Lookup</a></span></span><span class='period'>.</span><span class='id identifier rubyid_id'><span class='object_link'><a href="Lookup.html#id-class_method" title="CombatTracker::Lookup.id (method)">id</a></span></span><span class='lparen'>(</span><span class='symbol'>:resolution_types</span><span class='comma'>,</span> <span class='id identifier rubyid_res'>res</span><span class='lbracket'>[</span><span class='symbol'>:type</span><span class='rbracket'>]</span><span class='rparen'>)</span>

  <span class='comment'># build the full row with all NOT NULL fields
</span>  <span class='id identifier rubyid_row'>row</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='label'>session_id:</span>      <span class='id identifier rubyid_session_id'>session_id</span><span class='comma'>,</span>
    <span class='label'>attack_id:</span>       <span class='id identifier rubyid_atk_id'>atk_id</span><span class='comma'>,</span>
    <span class='label'>sequence:</span>        <span class='id identifier rubyid_seq'>seq</span><span class='comma'>,</span>
    <span class='label'>resolution_type:</span> <span class='id identifier rubyid_type_id'>type_id</span><span class='comma'>,</span>
    <span class='label'>result_total:</span>    <span class='id identifier rubyid_res'>res</span><span class='lbracket'>[</span><span class='symbol'>:data</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:result</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
    <span class='label'>d100_roll:</span>       <span class='id identifier rubyid_res'>res</span><span class='lbracket'>[</span><span class='symbol'>:data</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:roll</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
  <span class='rbrace'>}</span>

  <span class='comment'># insert and grab its PK
</span>  <span class='id identifier rubyid_res_id'>res_id</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../CombatTracker.html" title="CombatTracker (module)">CombatTracker</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="DebugInsert.html" title="CombatTracker::DebugInsert (module)">DebugInsert</a></span></span><span class='period'>.</span><span class='id identifier rubyid_insert'><span class='object_link'><a href="DebugInsert.html#insert-class_method" title="CombatTracker::DebugInsert.insert (method)">insert</a></span></span><span class='lparen'>(</span><span class='symbol'>:attack_resolutions</span><span class='comma'>,</span> <span class='id identifier rubyid_row'>row</span><span class='rparen'>)</span>

  <span class='comment'># now persist the components as before
</span>  <span class='id identifier rubyid_res'>res</span><span class='lbracket'>[</span><span class='symbol'>:data</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='op'>|</span>
    <span class='kw'>next</span> <span class='kw'>if</span> <span class='qsymbols_beg'>%i[</span><span class='tstring_content'>total</span><span class='words_sep'> </span><span class='tstring_content'>roll</span><span class='tstring_end'>]</span></span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../CombatTracker.html" title="CombatTracker (module)">CombatTracker</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="DebugInsert.html" title="CombatTracker::DebugInsert (module)">DebugInsert</a></span></span><span class='period'>.</span><span class='id identifier rubyid_insert'><span class='object_link'><a href="DebugInsert.html#insert-class_method" title="CombatTracker::DebugInsert.insert (method)">insert</a></span></span><span class='lparen'>(</span><span class='symbol'>:resolution_components</span><span class='comma'>,</span> <span class='lbrace'>{</span>
      <span class='label'>resolution_id:</span>   <span class='id identifier rubyid_res_id'>res_id</span><span class='comma'>,</span>
      <span class='label'>component_name:</span>  <span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span><span class='comma'>,</span>
      <span class='label'>component_value:</span> <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="persist_statuses-class_method">
  
    .<strong>persist_statuses</strong>(sts, atk_id, session_id)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Persists statuses associated with an attack.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_persist_statuses'>persist_statuses</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Stunned</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Burning</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='int'>1</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>session_123</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>sts</span>
      
      
        <span class='type'>(<tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the statuses to persist.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>atk_id</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the ID of the attack.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>session_id</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the ID of the current session.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


570
571
572
573
574
575
576
577
578
579
580</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'combattracker.rb', line 570</span>

<span class='kw'>def</span> <span class='id identifier rubyid_persist_statuses'>persist_statuses</span><span class='lparen'>(</span><span class='id identifier rubyid_sts'>sts</span><span class='comma'>,</span> <span class='id identifier rubyid_atk_id'>atk_id</span><span class='comma'>,</span> <span class='id identifier rubyid_session_id'>session_id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_now'>now</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>
  <span class='id identifier rubyid_sts'>sts</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_st'>st</span><span class='op'>|</span>
    <span class='const'><span class='object_link'><a href="../CombatTracker.html" title="CombatTracker (module)">CombatTracker</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="DebugInsert.html" title="CombatTracker::DebugInsert (module)">DebugInsert</a></span></span><span class='period'>.</span><span class='id identifier rubyid_insert'><span class='object_link'><a href="DebugInsert.html#insert-class_method" title="CombatTracker::DebugInsert.insert (method)">insert</a></span></span><span class='lparen'>(</span><span class='symbol'>:status_events</span><span class='comma'>,</span> <span class='lbrace'>{</span>
      <span class='label'>applied_by_attack:</span> <span class='id identifier rubyid_atk_id'>atk_id</span><span class='comma'>,</span>
      <span class='label'>status_type:</span>       <span class='const'><span class='object_link'><a href="Lookup.html" title="CombatTracker::Lookup (module)">Lookup</a></span></span><span class='period'>.</span><span class='id identifier rubyid_id'><span class='object_link'><a href="Lookup.html#id-class_method" title="CombatTracker::Lookup.id (method)">id</a></span></span><span class='lparen'>(</span><span class='symbol'>:status_types</span><span class='comma'>,</span> <span class='id identifier rubyid_st'>st</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>started_at:</span>        <span class='id identifier rubyid_now'>now</span><span class='comma'>,</span>
      <span class='label'>ended_at:</span>          <span class='kw'>nil</span>
    <span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process-class_method">
  
    .<strong>process</strong>(chunk)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Processes a chunk of combat event data.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="CombatTracker::Processor (module)">Processor</a></span></span><span class='period'>.</span><span class='id identifier rubyid_process'>process</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&lt;raw combat data&gt;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>chunk</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the raw data chunk containing combat events.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


362
363
364
365
366
367</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'combattracker.rb', line 362</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process'>process</span><span class='lparen'>(</span><span class='id identifier rubyid_chunk'>chunk</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_events'>events</span> <span class='op'>=</span> <span class='id identifier rubyid_parse_events'>parse_events</span><span class='lparen'>(</span><span class='id identifier rubyid_chunk'>chunk</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_events'>events</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>

  <span class='const'><span class='object_link'><a href="DB.html" title="CombatTracker::DB (module)">DB</a></span></span><span class='period'>.</span><span class='id identifier rubyid_conn'><span class='object_link'><a href="DB.html#conn-instance_method" title="CombatTracker::DB#conn (method)">conn</a></span></span><span class='period'>.</span><span class='id identifier rubyid_transaction'>transaction</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_events'>events</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_ev'>ev</span><span class='op'>|</span> <span class='id identifier rubyid_persist'>persist</span><span class='lparen'>(</span><span class='id identifier rubyid_ev'>ev</span><span class='rparen'>)</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="upsert_creature-class_method">
  
    .<strong>upsert_creature</strong>(session_id, tgt)  &#x21d2; <tt>Integer</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Upserts a creature instance in the database.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_creature_id'>creature_id</span> <span class='op'>=</span> <span class='id identifier rubyid_upsert_creature'>upsert_creature</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>session_123</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='lbrace'>{</span> <span class='label'>id:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='label'>noun:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Goblin</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Goblin Warrior</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>session_id</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the ID of the current session.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>tgt</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the target creature data.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the ID of the upserted creature instance.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>StandardError</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>if there is an issue with database operations.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


550
551
552
553
554
555
556
557
558
559
560</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'combattracker.rb', line 550</span>

<span class='kw'>def</span> <span class='id identifier rubyid_upsert_creature'>upsert_creature</span><span class='lparen'>(</span><span class='id identifier rubyid_session_id'>session_id</span><span class='comma'>,</span> <span class='id identifier rubyid_tgt'>tgt</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_now'>now</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>
  <span class='const'><span class='object_link'><a href="Log.html" title="CombatTracker::Log (module)">Log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="Log.html#log-class_method" title="CombatTracker::Log.log (method)">log</a></span></span><span class='lparen'>(</span><span class='symbol'>:DEBUG</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CREATURE</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>upsert_creature session_id=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_session_id'>session_id</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'>, exist_id=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_tgt'>tgt</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_exists'>exists</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="DB.html" title="CombatTracker::DB (module)">DB</a></span></span><span class='period'>.</span><span class='id identifier rubyid_conn'><span class='object_link'><a href="DB.html#conn-instance_method" title="CombatTracker::DB#conn (method)">conn</a></span></span><span class='lbracket'>[</span><span class='symbol'>:combat_sessions</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>id:</span> <span class='id identifier rubyid_session_id'>session_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='period'>.</span><span class='id identifier rubyid_positive?'>positive?</span>
  <span class='const'><span class='object_link'><a href="Log.html" title="CombatTracker::Log (module)">Log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="Log.html#log-class_method" title="CombatTracker::Log.log (method)">log</a></span></span><span class='lparen'>(</span><span class='symbol'>:DEBUG</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CREATURE</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>  combat_sessions[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_session_id'>session_id</span><span class='embexpr_end'>}</span><span class='tstring_content'>] exists? </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_exists'>exists</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='const'><span class='object_link'><a href="DB.html" title="CombatTracker::DB (module)">DB</a></span></span><span class='period'>.</span><span class='id identifier rubyid_conn'><span class='object_link'><a href="DB.html#conn-instance_method" title="CombatTracker::DB#conn (method)">conn</a></span></span><span class='lbracket'>[</span><span class='symbol'>:creature_instances</span><span class='rbracket'>]</span>
    <span class='period'>.</span><span class='id identifier rubyid_insert_conflict'>insert_conflict</span><span class='lparen'>(</span><span class='label'>target:</span> <span class='qsymbols_beg'>%i[</span><span class='tstring_content'>session_id</span><span class='words_sep'> </span><span class='tstring_content'>exist_id</span><span class='tstring_end'>]</span></span><span class='comma'>,</span> <span class='label'>update:</span> <span class='lbrace'>{</span> <span class='label'>last_seen_at:</span> <span class='id identifier rubyid_now'>now</span> <span class='rbrace'>}</span><span class='rparen'>)</span>
    <span class='period'>.</span><span class='id identifier rubyid_insert'>insert</span><span class='lparen'>(</span><span class='label'>session_id:</span> <span class='id identifier rubyid_session_id'>session_id</span><span class='comma'>,</span> <span class='label'>exist_id:</span> <span class='id identifier rubyid_tgt'>tgt</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>noun:</span> <span class='id identifier rubyid_tgt'>tgt</span><span class='lbracket'>[</span><span class='symbol'>:noun</span><span class='rbracket'>]</span><span class='comma'>,</span>
            <span class='label'>display_name:</span> <span class='id identifier rubyid_tgt'>tgt</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>first_seen_at:</span> <span class='id identifier rubyid_now'>now</span><span class='comma'>,</span> <span class='label'>last_seen_at:</span> <span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span>
  <span class='const'><span class='object_link'><a href="DB.html" title="CombatTracker::DB (module)">DB</a></span></span><span class='period'>.</span><span class='id identifier rubyid_conn'><span class='object_link'><a href="DB.html#conn-instance_method" title="CombatTracker::DB#conn (method)">conn</a></span></span><span class='lbracket'>[</span><span class='symbol'>:creature_instances</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>session_id:</span><span class='comma'>,</span> <span class='label'>exist_id:</span> <span class='id identifier rubyid_tgt'>tgt</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='symbol'>:id</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Thu May 22 10:43:54 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.37 (ruby-3.3.4).
</div>

    </div>
  </body>
</html>